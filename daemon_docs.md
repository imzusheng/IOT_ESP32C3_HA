# ESP32C3 守护进程模块文档

## 概述

守护进程模块为ESP32C3 IoT设备提供全面的系统监控和安全保护功能。该模块采用轻量级设计，适合在资源受限的嵌入式环境中运行，并集成了MQTT日志功能，便于远程监控。

## 主要功能

### 1. LED状态指示
- **LED1（引脚12）**：主要状态指示
- **LED2（引脚13）**：辅助状态指示
- **状态模式**：
  - `normal`：LED1亮，LED2灭（正常运行）
  - `warning`：LED1亮，LED2亮（警告状态）
  - `error`：LED1灭，LED2亮（错误状态）
  - `safe_mode`：交替闪烁（安全模式）
  - `off`：全部关闭（关闭状态）

### 2. 温度监控
- 监控ESP32C3内部MCU温度
- 温度超过阈值（60°C）自动进入安全模式
- 温度恢复到阈值以下10°C且冷却时间到后自动退出安全模式

### 3. 内存监控
- 实时监控SRAM使用情况
- 内存使用超过90%自动进入安全模式
- 自动垃圾回收机制

### 4. 看门狗保护
- 8秒看门狗超时
- 定期喂狗防止系统死锁
- 监控错误时自动重置系统

### 5. 安全模式
- 危险情况下自动进入安全模式
- LED交替闪烁指示安全模式
- 冷却时间30秒防止频繁切换
- 支持温度和内存阈值保护

### 6. MQTT日志集成
- 所有守护进程事件通过MQTT发送
- 支持不同日志级别（INFO、WARNING、ERROR、CRITICAL）
- 系统状态定期报告

## 配置参数

### 全局配置常量

```python
# LED配置
LED_PIN_1 = 12                    # LED1引脚号
LED_PIN_2 = 13                    # LED2引脚号

# 温度监控配置
TEMP_THRESHOLD = 60.0             # 温度阈值（摄氏度）
# 范围：50-80°C，推荐：60°C
# 影响：超过此值将进入安全模式

# 安全模式配置
SAFE_MODE_COOLDOWN = 30000        # 安全模式冷却时间（毫秒）
# 范围：10-60秒，推荐：30秒
# 影响：在此时间内不会自动退出安全模式

# 看门狗配置
WDT_TIMEOUT = 10000                # 看门狗超时时间（毫秒）
# 范围：1000-32000ms，推荐：8000ms
# 影响：超过此时间不喂狗将导致系统重启

# 监控间隔配置
MONITOR_INTERVAL = 30000          # 监控间隔（毫秒）
# 范围：1000-60000ms，推荐：30000ms
# 影响：监控频率，间隔越短响应越快但占用更多资源

# 内存监控配置
MEMORY_THRESHOLD = 90             # 内存使用阈值（百分比）
# 范围：70-95%，推荐：90%
# 影响：超过此值将进入安全模式

# 错误处理配置
MAX_ERROR_COUNT = 5              # 最大错误计数
ERROR_RESET_INTERVAL = 60000     # 错误重置间隔（毫秒）
# 范围：30-300秒，推荐：60秒
# 影响：在此时间内错误超过最大值将进入安全模式
```

## 全局变量说明

### 状态变量
- `_daemon_active`：守护进程是否活跃
- `_safe_mode_active`：是否处于安全模式
- `_safe_mode_start_time`：安全模式开始时间
- `_start_time`：守护进程启动时间
- `_monitor_count`：监控次数计数器

### 错误处理变量
- `_error_count`：错误计数器
- `_last_error_time`：最后一次错误时间

### 硬件对象
- `_wdt`：看门狗实例
- `_timer`：监控定时器实例
- `_led_controller`：LED控制器实例
- `_mqtt_client`：MQTT客户端实例

## 使用方法

### 1. 基本使用

```python
import daemon
import mqtt

# 创建MQTT客户端
mqtt_server = mqtt.MqttServer(CLIENT_ID, MQTT_BROKER, topic=MQTT_TOPIC)
mqtt_server.connect()

# 设置MQTT客户端给守护进程
daemon.set_mqtt_client(mqtt_server)

# 启动守护进程
daemon_started = daemon.start_daemon()
if not daemon_started:
    print("守护进程启动失败")

# 检查守护进程状态
if daemon.is_daemon_active():
    print("守护进程运行中")

# 检查安全模式
if daemon.is_safe_mode():
    print("系统处于安全模式")
    # 暂停正常操作
else:
    # 正常操作
    pass

# 获取详细状态
status = daemon.get_daemon_status()
print(f"温度: {status['temperature']}°C")
print(f"内存使用: {status['memory']['percent']}%")
```

### 2. 停止守护进程

```python
# 停止守护进程（保持看门狗运行）
daemon.stop_daemon()
```

## 内存管理

### 垃圾回收策略
- **获取内存信息前**：自动执行垃圾回收
- **进入安全模式时**：执行垃圾回收
- **退出安全模式时**：执行垃圾回收
- **定期回收**：每100次监控执行一次垃圾回收
- **停止守护进程时**：执行垃圾回收

### 内存优化
- 使用全局变量减少对象创建
- 避免在监控循环中创建临时对象
- 使用简单的数据结构
- 及时释放不再使用的资源

## 监控任务

### 监控回调函数执行流程
1. **喂狗**（最高优先级）
2. **温度监控**
3. **内存监控**
4. **错误计数管理**
5. **系统状态记录**（每30次监控）
6. **LED状态控制**
7. **安全模式管理**
8. **垃圾回收**（每100次监控）

### 异常处理
- 监控函数包含完整的异常处理
- 错误不会中断监控流程
- 错误信息通过MQTT发送
- 错误计数过多会触发安全模式

## MQTT日志格式

### 日志级别
- **INFO**：正常系统状态信息
- **WARNING**：警告信息
- **ERROR**：错误信息
- **CRITICAL**：严重错误信息

### 系统状态日志
```
运行时间: 123s, 温度: 45.2°C, 内存: 85.3% (60KB空闲), 错误: 0
```

### 安全模式日志
```
进入安全模式: 温度过高: 62.5°C
退出安全模式
```

## 错误处理

### 错误类型
1. **硬件初始化错误**：LED、看门狗、定时器初始化失败
2. **监控错误**：温度或内存读取失败
3. **MQTT通信错误**：日志发送失败
4. **系统错误**：其他未知错误

### 错误恢复
- 错误计数达到阈值（5次）进入安全模式
- 错误重置间隔（60秒）后自动重置错误计数
- 安全模式提供错误恢复机制

## 安全模式

### 进入条件
- 温度 ≥ 60°C
- 内存使用 ≥ 90%
- 错误计数 ≥ 5次且在60秒内

### 退出条件
- 温度 < 50°C
- 安全模式持续时间 ≥ 30秒

### 安全模式行为
- LED交替闪烁
- 暂停正常系统操作
- 持续监控温度和内存
- 等待人为干预或自动恢复

## 性能考虑

### 资源使用
- **内存**：约2-3KB（不包括MQTT客户端）
- **CPU**：监控间隔30秒，CPU占用极低
- **定时器**：使用1个硬件定时器
- **GPIO**：使用2个GPIO引脚（LED）

### 优化建议
1. 监控间隔可根据需要调整（推荐30秒）
2. 温度阈值可根据环境调整（推荐60°C）
3. 内存阈值可根据系统需求调整（推荐90%）
4. 看门狗超时时间应大于监控间隔（推荐8秒）

## 故障排除

### 常见问题
1. **守护进程启动失败**
   - 检查硬件资源是否可用
   - 检查MQTT连接是否正常
   - 查看错误日志

2. **频繁进入安全模式**
   - 检查温度传感器是否正常
   - 检查内存使用情况
   - 调整阈值参数

3. **LED不工作**
   - 检查LED引脚连接
   - 检查GPIO初始化
   - 检查电源供应

### 调试方法
- 使用MQTT日志查看运行状态
- 检查LED状态指示
- 监控系统内存使用
- 查看错误计数

## 版本信息

- **版本**：1.0.0
- **兼容性**：MicroPython 1.19+，ESP32C3
- **依赖**：machine, time, gc, esp32（可选）

## 许可证

本模块遵循项目许可证。