# deploy.py 监听功能使用说明

## 概述

`deploy.py` 现已升级到 v4.2 版本，新增了Thonny-like交互式开发环境、智能ESP32-C3设备检测和串口监听功能。脚本默认启用调试模式，可以实时监听设备输出，便于调试和开发。

## 主要功能

### 1. 智能ESP32-C3设备检测
- **多层级关键词匹配**：从ESP32-C3特定标识到通用串口设备
- **硬件ID识别**：支持ESP32-C3常见的VID/PID匹配
- **评分机制**：为每个匹配的关键词分配不同分数，自动选择最可能的设备
- **详细设备信息**：显示匹配分数、关键词和硬件ID

### 2. 串口监听功能
- **简单监听模式**：监听指定时长的串口输出
- **交互式监听模式**：实时监听与状态监控
- **文本过滤**：只显示包含指定文本的行
- **时间戳显示**：为每行输出添加时间戳

### 3. Thonny-like交互式开发环境
- **完整开发环境**：提供类似Thonny的交互式开发体验
- **RST复位功能**：支持开发板软复位和完全重启
- **文件上传**：在交互环境中直接编译和上传文件
- **代码执行**：支持直接执行MicroPython代码
- **持续监听**：上传文件后自动进入监听模式
- **设备状态**：实时显示设备信息和运行状态

### 4. 调试模式
- **默认启用**：`DEBUG = True`
- **详细输出**：在部署和监听过程中提供更多信息
- **可配置**：通过命令行参数控制

## 使用示例

### 1. 基本部署（默认启用调试）
```bash
python deploy.py
```

### 2. 监听串口输出30秒
```bash
python deploy.py --listen 30
```

### 3. 监听并过滤DEBUG信息
```bash
python deploy.py --listen --filter "DEBUG"
```

### 4. 交互式监听模式
```bash
python deploy.py --listen-interactive
```

### 5. 指定串口监听
```bash
python deploy.py --port COM7 --listen 60
```

### 6. 跳过编译直接部署
```bash
python deploy.py --no-compile
```

### 7. 启动Thonny-like交互式开发环境
```bash
python deploy.py --interactive
```

### 8. 部署后自动监听
```bash
python deploy.py --auto-monitor
```

### 9. 禁用调试模式
```bash
python deploy.py --no-debug
```

## 监听模式功能

### 简单监听模式
- 持续监听指定时长的串口输出
- 支持文本过滤
- 自动时间戳显示
- Ctrl+C 可提前结束

### 交互式监听模式
- 实时显示串口输出
- 自动状态报告
- 简化的命令系统（Windows环境）

## 智能检测说明

### 检测优先级
1. **ESP32-C3特定标识**：`esp32-c3`, `esp32c3`, `esp32-c3s2`, `esp32s3`
2. **ESP32通用标识**：`esp32`, `espressif`, `usb jtag/serial`
3. **USB转串口芯片**：CH340/CH341, CP210x系列, FTDI系列, PL2303系列
4. **通用串口设备**：`uart`, `serial`, `com port`
5. **硬件ID匹配**：`303a`(Espressif), `10c4`(Silicon Labs), `1a86`(WCH), `0403`(FTDI)

### 评分机制
- 不同优先级的关键词获得不同分数
- 硬件ID匹配获得额外加分
- 按分数排序显示最可能的设备

## 命令行参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--listen [秒数]` | 监听串口输出指定秒数 | `python deploy.py --listen 30` |
| `--listen-interactive` | 交互式监听模式 | `python deploy.py --listen-interactive` |
| `--interactive`, `--shell` | 启动Thonny-like交互式开发环境 | `python deploy.py --interactive` |
| `--auto-monitor` | 部署后自动进入监听模式 | `python deploy.py --auto-monitor` |
| `--filter 文本` | 过滤监听输出，只显示包含指定文本的行 | `python deploy.py --listen --filter "DEBUG"` |
| `--port 串口` | 指定串口设备 | `python deploy.py --port COM7` |
| `--no-compile` | 跳过编译步骤，直接部署源文件 | `python deploy.py --no-compile` |
| `--debug` | 启用调试模式（默认启用） | `python deploy.py --debug` |
| `--no-debug` | 禁用调试模式 | `python deploy.py --no-debug` |
| `--help` | 显示帮助信息 | `python deploy.py --help` |

## 监听模式详细说明

### 简单监听模式 (`--listen`)
- 持续监听指定时长的串口输出
- 支持文本过滤功能
- 自动显示时间戳
- 按 `Ctrl+C` 可提前结束监听
- 适用于短期调试和日志查看

### 交互式监听模式 (`--listen-interactive`)
- 实时显示串口输出，无时间限制
- 自动状态报告（每10秒显示运行状态）
- 简化的监控界面
- 适用于长期监控和持续调试
- 按 `Ctrl+C` 结束监听

### Thonny-like交互式开发环境 (`--interactive`)
- 提供完整的交互式开发体验
- **可用命令**：
  - `help, h` - 显示帮助信息
  - `rst, reset` - 复位开发板（Ctrl+D）
  - `upload` - 编译并上传文件到开发板
  - `monitor, m` - 开始持续监听模式
  - `listen X` - 监听X秒后自动停止
  - `filter X` - 设置输出过滤条件
  - `clear` - 清除过滤条件
  - `status` - 显示设备状态信息
  - `exec <code>` - 执行MicroPython代码
  - `reboot` - 完全重启开发板
  - `exit, quit` - 退出交互模式
- **特点**：
  - 实时显示串口输出
  - 支持命令历史和自动补全（基础）
  - 设备状态实时监控
  - 文件上传后自动监听
  - 错误处理和恢复机制

## 智能检测详细说明

### 检测优先级和评分
1. **ESP32-C3特定标识**（90-100分）：`esp32-c3`, `esp32c3`, `esp32-c3s2`, `esp32s3`
2. **ESP32通用标识**（30-60分）：`esp32`, `espressif`, `usb jtag/serial`
3. **USB转串口芯片**（5-25分）：CH340/CH341, CP210x系列, FTDI系列, PL2303系列
4. **通用串口设备**（2-10分）：`uart`, `serial`, `com port`
5. **硬件ID匹配**（额外加分）：`303a`(Espressif), `10c4`(Silicon Labs), `1a86`(WCH), `0403`(FTDI)

### 设备选择逻辑
- 自动检测所有可用串口设备
- 为每个设备计算匹配分数
- 按分数排序显示检测结果
- 单个设备自动选择，多个设备提供选择界面

## 常见问题解决

### 1. 监听没有输出
**可能原因**：
- 设备未正确连接或未开机
- 设备没有串口输出
- 串口被其他程序占用
- 驱动程序问题

**解决方案**：
- 检查设备连接和电源
- 确保设备正在运行并输出数据
- 关闭其他可能占用串口的程序
- 重新安装串口驱动
- 使用 `--port` 参数指定串口

### 2. 设备检测失败
**可能原因**：
- 串口驱动未安装
- 设备连接问题
- 硬件故障

**解决方案**：
- 安装对应的串口驱动（CH340/CP210x等）
- 重新插拔设备或更换USB线
- 尝试在其他电脑上测试

### 3. 编译失败
**可能原因**：
- mpy-cross未安装或版本不兼容
- Python代码语法错误
- MicroPython版本问题

**解决方案**：
- 安装正确版本的mpy-cross
- 检查代码语法错误
- 使用 `--no-compile` 跳过编译步骤

### 4. 部署失败
**可能原因**：
- 串口通信问题
- 设备存储空间不足
- 文件权限问题

**解决方案**：
- 检查串口连接和驱动
- 清理设备存储空间
- 使用管理员权限运行脚本

## 注意事项

1. **Windows环境**：交互式监听模式在Windows上功能有限，建议使用简单监听模式
2. **权限问题**：某些系统可能需要管理员权限访问串口设备
3. **设备冲突**：确保没有其他程序占用目标串口
4. **编码问题**：串口输出可能包含特殊字符，脚本已做编码处理
5. **超时设置**：长时间监听建议使用交互式模式
6. **数据量**：大量数据输出时建议使用过滤功能减少干扰

## 版本信息

- **当前版本**：v4.2
- **主要更新**：Thonny-like交互式开发环境、RST复位功能、智能ESP32-C3检测、串口监听功能、调试模式优化
- **兼容性**：Windows/Linux/macOS
- **依赖**：Python 3.6+, pyserial, mpy-cross (可选)

## 交互式开发环境使用场景

### 开发工作流
1. **代码编辑**：在本地编辑MicroPython源代码
2. **快速部署**：使用 `upload` 命令编译并上传文件
3. **实时调试**：上传后自动进入监听模式，查看输出
4. **交互测试**：使用 `exec` 命令执行测试代码
5. **状态监控**：使用 `status` 命令查看设备状态
6. **问题复位**：使用 `rst` 或 `reboot` 命令复位设备

### 典型使用场景
- **开发调试**：编写代码 → 上传 → 监听 → 调试 → 重复
- **性能测试**：上传测试代码 → 持续监听 → 分析输出
- **设备维护**：查看状态 → 执行诊断命令 → 复位设备
- **学习实验**：交互式执行MicroPython代码 → 观察结果

## 获取帮助

- 查看帮助：`python deploy.py --help`
- 项目文档：参考 `README.md` 和 `CLAUDE.md`
- 问题反馈：通过项目Issue系统反馈问题