# -*- coding: utf-8 -*-
"""
配置模块

所有配置项都在此文件中直接定义，并附有详细说明。
通过 `get_config()` 函数可以安全地访问这些配置。
要修改配置，直接编辑下面的 CONFIG 字典即可。
注释旨在帮助理解每个参数的用途、对项目的影响以及推荐的设定范围。
"""

import gc

# =============================================================================
# 配置数据 (唯一配置源)
# =============================================================================

CONFIG = {
    # 网络统一控制器配置
    "network": {
        # 描述: 网络重连的基础退避时间，单位为秒。
        # 影响: 这是所有网络连接重连的基础时间间隔，影响WiFi和MQTT的重连策略。
        # 建议: 2-5 秒。
        "backoff_base": 2,

        # 描述: 网络重连的退避倍数因子。
        # 影响: 决定了重连间隔增长的速度，值越大增长越快。影响WiFi和MQTT的重连频率。
        # 建议: 1.5-3（2的幂次增长是常见策略）。
        "backoff_multiplier": 2,

        # 描述: 网络重连的最大退避时间，单位为秒。
        # 影响: 限制了所有网络连接重连的最大等待时间，避免等待时间过长影响服务恢复。
        # 建议: 300-600 秒（5-10分钟）。
        "max_backoff_time": 300,

        # 描述: 网络连接的最大重试次数。
        # 影响: 限制了WiFi、NTP、MQTT连接的最大重试次数，超过后停止重试。
        # 建议: 3-10 次。
        "max_retries": 5,

        # 描述: WiFi连接的最大等待时间，单位为毫秒。
        # 影响: 决定了WiFi连接建立的最长等待时间，时间太短可能导致误判连接失败。
        # 建议: 5000-15000 毫秒（5-15秒）。
        "wifi_max_wait": 10000,

        # 描述: WiFi连接状态检查间隔，单位为毫秒。
        # 影响: 决定了检查WiFi连接状态的频率，间隔太短会增加CPU负担。
        # 建议: 100-500 毫秒。
        "wifi_check_interval": 200,

        # 描述: MQTT连接的最大等待时间，单位为毫秒。
        # 影响: 决定了MQTT连接建立的最长等待时间，时间太短可能导致误判连接失败。
        # 建议: 3000-10000 毫秒（3-10秒）。
        "mqtt_max_wait": 5000,

        # 描述: MQTT连接状态检查间隔，单位为毫秒。
        # 影响: 决定了检查MQTT连接状态的频率，间隔太短会增加CPU负担。
        # 建议: 100-500 毫秒。
        "mqtt_check_interval": 200,

        # 描述: 网络连接状态检查间隔，单位为毫秒。
        # 影响: 决定了系统检查WiFi和MQTT连接状态的频率，影响网络故障的发现速度。
        # 建议: 10000-60000 毫秒（10-60秒）。
        "connection_check_interval": 30000
    },

    "mqtt": {
        # 描述: MQTT服务器的IP地址或域名。
        # 影响: 这是设备与MQTT代理通信的核心地址。如果错误，设备将无法连接到消息服务器，所有远程通信功能将失效。
        # 建议: 推荐使用内网的静态IP地址，例如 "192.168.3.15"。
        "broker": "192.168.3.15",

        # 描述: MQTT服务器的端口号。
        # 影响: 必须与服务器配置的端口完全一致，否则无法建立TCP连接。
        # 建议: 标准端口为 `1883`，使用TLS/SSL加密时通常为 `8883`。
        "port": 1883,

        # 描述: MQTT连接的用户名（可选）。
        # 影响: 如果MQTT服务器启用了身份验证，需要提供正确的用户名。
        # 建议: 根据服务器配置填写。
        "user": "",

        # 描述: MQTT连接的密码（可选）。
        # 影响: 如果MQTT服务器启用了身份验证，需要提供正确的密码。
        # 建议: 根据服务器配置填写。
        "password": "",

        # 描述: MQTT连接的保活心跳时间，单位为秒。
        # 影响: 设备会按此周期向服务器发送心跳包以维持连接。值太小会增加网络流量；值太大会导致服务器延迟发现设备离线。
        # 建议: 30-120 秒。
        "keepalive": 60,

        # 描述: MQTT自动订阅的主题列表。
        # 影响: 连接成功后会自动订阅这些主题，用于接收命令或数据。
        # 建议: 根据实际需求配置主题列表。
        "subscribe_topics": [
            "lzs/esp32c3/command",
            "device/esp32c3/+"
        ]
    },
    "wifi": {
        # 描述: WiFi网络列表，设备将按信号强度排序后尝试连接。
        # 影响: 这是设备接入网络的基础。如果列表为空或所有网络都无法连接，设备将处于离线状态。
        # 建议: 将最稳定或最常用的WiFi网络放在列表的最前面。
        "networks": [
            {"ssid": "zsm60p", "password": "25845600"},
            {"ssid": "leju_software", "password": "leju123456"},
            {"ssid": "CMCC-pdRG", "password": "7k77ed5p"}
        ]
    },

    "ntp": {
        # 描述: NTP时间同步服务器地址。
        # 影响: 连接成功后将自动向此服务器发起时间同步。影响设备的时间准确性。
        # 建议: 国内网络使用阿里云 ntp1.aliyun.com 或 pool.ntp.org 池。
        "ntp_server": "ntp1.aliyun.com",

        # 描述: NTP同步的最大重试次数。
        # 影响: 限制了NTP同步失败时的重试次数，避免无限重试消耗资源。
        # 建议: 3-5 次。
        "ntp_max_attempts": 3,

        # 描述: NTP重试的间隔时间，单位为秒。
        # 影响: 决定了NTP同步失败后再次尝试的时间间隔。
        # 建议: 1-5 秒。
        "ntp_retry_interval": 2
    },
    "daemon": {
        # 描述: 系统在进入安全模式或重启前，允许累计的最大错误次数。
        # 影响: 这是一个容错机制，避免因为瞬时或小概率的错误导致系统频繁重启。
        # 建议: 5-20 次。
        "max_error_count": 10,

        # 描述: 看门狗定时器(WDT)的超时时间，单位为毫秒。
        # 影响: 如果主程序在指定时间内没有"喂狗"(feed)，看门狗将强制重启设备。这是防止固件死锁或主循环卡死的最后防线。
        # 建议: 60000-300000 毫秒，必须远大于主循环的正常执行时间。
        "wdt_timeout": 120000,

        # 描述: 是否启用硬件看门狗。
        # 影响: 生产环境中强烈建议启用，以保证设备在无人值守的情况下能从未知错误中自愈。开发调试时可关闭。
        # 建议: 生产环境 `True`，开发环境 `False`。
        "wdt_enabled": True
    },
    "system": {
        # 描述: 主循环(main loop)的延迟时间，单位为毫秒。
        # 影响: 这是主循环每次迭代的间隔，直接影响系统的响应速度和CPU使用率。值越小响应越快，但CPU占用越高，也越耗电。
        # 建议: 100-1000 毫秒。
        "main_loop_delay": 50
    }
}


# =============================================================================
# 配置访问接口
# =============================================================================

def get_config(section: str = None, key: str = None, default=None):
    """
    从模块内部的 CONFIG 字典中安全地获取配置值。

    Args:
        section (str, optional): 配置段名称。如果为None，返回整个配置字典。
        key (str, optional): 配置键名。如果为None，返回整个配置段。
        default: 默认值，当指定的键不存在时返回。

    Returns:
        配置值或配置字典。
    """
    if section is None:
        return CONFIG

    section_data = CONFIG.get(section, {})

    if key is None:
        return section_data

    return section_data.get(key, default)

# =============================================================================
# 初始化
# =============================================================================

gc.collect()

# Configuration module loaded silently