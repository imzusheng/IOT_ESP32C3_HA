# ESP32-C3 IoT事件驱动架构动画文档 (不具备参考性)

## 系统启动流程动画

### 场景1: 系统启动 (0-3秒)

```
┌─────────────────────────────────────────────────────────────┐
│                     系统启动流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🚀 [main.py] 系统启动                                      │
│     ↓                                                      │
│  📦 [Config] 加载配置                                      │
│     ↓                                                      │
│  🏗️  [MainController] 创建主控制器                          │
│     ↓                                                      │
│  🚌 [EventBus] 初始化事件总线                              │
│     ↓                                                      │
│  🏊 [ObjectPool] 创建对象池                                │
│     ↓                                                      │
│  💾 [StaticCache] 初始化静态缓存                            │
│     ↓                                                      │
│  📝 [Logger] 设置日志系统                                  │
│     ↓                                                      │
│  🎯 [SystemFSM] 创建状态机                                 │
│     ↓                                                      │
│  🌐 [WifiManager] 初始化WiFi管理器                         │
│     ↓                                                      │
│  📡 [MqttController] 初始化MQTT控制器                       │
│     ↓                                                      │
│  💡 [LEDPatternController] 初始化LED控制器                   │
│     ↓                                                      │
│  📊 [SensorManager] 初始化传感器管理器                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 场景2: 事件总线初始化 (3-6秒)

```
┌─────────────────────────────────────────────────────────────┐
│                   EventBus初始化                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🚌 EventBus实例创建                                        │
│     ↓                                                      │
│  📋 初始化内部数据结构                                      │
│     │                                                      │
│     ├─ 🔗 bus = {}                                         │
│     ├─ 🛡️ _MAX_ERROR_RECURSION = 3                         │
│     ├─ ⏱️  事件频率限制器初始化                              │
│     └─ 📊 调度错误计数器初始化                              │
│     ↓                                                      │
│  🎯 单例模式确保                                          │
│     ↓                                                      │
│  ✅ EventBus准备就绪                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 场景3: 状态机启动 (6-9秒)

```
┌─────────────────────────────────────────────────────────────┐
│                   状态机启动流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🎯 [SystemFSM] 状态机初始化                               │
│     ↓                                                      │
│  📊 构建状态转换表                                          │
│     │                                                      │
│     ├─ BOOT → INIT → NETWORKING → RUNNING                 │
│     ├─ RUNNING → WARNING → ERROR → SAFE_MODE              │
│     └─ RECOVERY → RUNNING/SAFE_MODE                       │
│     ↓                                                      │
│  🎮 设置状态处理器                                          │
│     │                                                      │
│     ├─ _handle_boot_state()                                │
│     ├─ _handle_init_state()                                │
│     ├─ _handle_networking_state()                         │
│     └─ ...                                                │
│     ↓                                                      │
│  📡 订阅系统事件                                           │
│     │                                                      │
│     ├─ SYSTEM_BOOT, SYSTEM_INIT                           │
│     ├─ WIFI_CONNECTED, WIFI_DISCONNECTED                 │
│     ├─ MQTT_CONNECTED, MQTT_DISCONNECTED                 │
│     └─ SYSTEM_ERROR, MEMORY_CRITICAL                      │
│     ↓                                                      │
│  🐕 启用看门狗 (如果配置启用)                               │
│     ↓                                                      │
│  ✅ 状态机准备就绪，当前状态: BOOT                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 事件传播动画

### 场景4: WiFi连接事件传播 (9-12秒)

```
┌─────────────────────────────────────────────────────────────┐
│                WiFi连接事件传播流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📶 [WifiManager] 检测到WiFi连接                            │
│     ↓                                                      │
│  📡 发布 WIFI_CONNECTED 事件                               │
│     ↓                                                      │
│  🚌 [EventBus] 接收事件                                     │
│     │                                                      │
│     ├─ 📋 查找订阅者列表                                   │
│     ├─ ⚡ 异步调度回调函数                                  │
│     └─ 🛡️ 应用频率限制 (防止重复事件)                       │
│     ↓                                                      │
│  📢 事件传播给所有订阅者:                                   │
│     │                                                      │
│     ├─ 🎯 [SystemFSM] 状态转换: NETWORKING → RUNNING       │
│     ├─ 💡 [LEDPatternController] LED模式: pulse → cruise    │
│     ├─ 📝 [Logger] 记录连接成功日志                         │
│     ├─ 💾 [StaticCache] 保存连接状态                         │
│     └─ 📡 [MqttController] 开始MQTT连接                     │
│     ↓                                                      │
│  ✅ WiFi连接事件处理完成                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 场景5: MQTT连接事件传播 (12-15秒)

```
┌─────────────────────────────────────────────────────────────┐
│                MQTT连接事件传播流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📡 [MqttController] MQTT连接成功                           │
│     ↓                                                      │
│  📡 发布 MQTT_CONNECTED 事件                               │
│     ↓                                                      │
│  🚌 [EventBus] 异步处理事件                                 │
│     │                                                      │
│     ├─ 🏊 从对象池获取事件对象                              │
│     ├─ 📋 查找订阅者: SystemFSM, Logger, LED                │
│     └─ ⏰ 调度回调执行                                      │
│     ↓                                                      │
│  📢 事件分发:                                              │
│     │                                                      │
│     ├─ 🎯 [SystemFSM] 确认RUNNING状态                       │
│     ├─ 💡 [LEDPatternController] 保持cruise模式              │
│     ├─ 📝 [Logger] 记录MQTT连接成功                         │
│     └─ 🔄 [MainController] 处理连接成功事件                 │
│     ↓                                                      │
│  ✅ MQTT连接事件处理完成                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 状态转换动画

### 场景6: 正常状态转换 (15-18秒)

```
┌─────────────────────────────────────────────────────────────┐
│                  正常状态转换流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🎯 当前状态: BOOT                                         │
│     ↓                                                      │
│  ⏱️  1秒延迟                                              │
│     ↓                                                      │
│  📡 发布 SYSTEM_BOOT 事件                                   │
│     ↓                                                      │
│  🎯 状态转换: BOOT → INIT                                  │
│     ↓                                                      │
│  💡 LED模式: off → blink                                  │
│     ↓                                                      │
│  ⏱️  2秒延迟                                              │
│     ↓                                                      │
│  📡 发布 SYSTEM_INIT 事件                                   │
│     ↓                                                      │
│  🎯 状态转换: INIT → NETWORKING                            │
│     ↓                                                      │
│  💡 LED模式: blink → pulse                                 │
│     ↓                                                      │
│  📶 [WifiManager] 开始WiFi连接                              │
│     ↓                                                      │
│  ✅ 系统进入NETWORKING状态                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 场景7: 错误状态转换 (18-21秒)

```
┌─────────────────────────────────────────────────────────────┐
│                  错误状态转换流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🎯 当前状态: RUNNING                                      │
│     ↓                                                      │
│  ⚠️  检测到系统错误 (如内存不足)                           │
│     ↓                                                      │
│  📡 发布 SYSTEM_ERROR 事件                                  │
│     ↓                                                      │
│  🚌 [EventBus] 处理错误事件                                │
│     │                                                      │
│     ├─ 🛡️ 错误递归深度检查                                │
│     ├─ 📊 错误计数器递增                                  │
│     └─ 📢 传播给订阅者                                    │
│     ↓                                                      │
│  🎯 [SystemFSM] 状态转换: RUNNING → ERROR                  │
│     ↓                                                      │
│  💡 [LEDPatternController] LED模式: cruise → blink         │
│     ↓                                                      │
│  📝 [Logger] 记录错误日志                                  │
│     ↓                                                      │
│  💾 [StaticCache] 保存错误状态                              │
│     ↓                                                      │
│  ⏱️  15秒后自动恢复尝试                                    │
│     ↓                                                      │
│  📡 发布 RECOVERY_SUCCESS 事件                              │
│     ↓                                                      │
│  🎯 状态转换: ERROR → WARNING                              │
│     ↓                                                      │
│  ✅ 系统进入WARNING状态，尝试恢复                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 内存管理动画

### 场景8: 对象池使用 (21-24秒)

```
┌─────────────────────────────────────────────────────────────┐
│                   对象池使用流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🏊 [ObjectPoolManager] 对象池管理器                        │
│     │                                                      │
│     ├─ 📦 mqtt_messages: 10个对象                          │
│     ├─ 📊 sensor_data: 5个对象                             │
│     ├─ 📝 log_messages: 20个对象                           │
│     └─ 🎯 system_events: 15个对象                          │
│                                                             │
│  📡 [MqttController] 需要发送消息                           │
│     ↓                                                      │
│  🏊 从对象池获取消息对象                                    │
│     │                                                      │
│     ├─ 🔍 查找可用对象                                     │
│     ├─ ✅ 标记为使用中                                     │
│     └─ 📦 返回对象                                         │
│     ↓                                                      │
│  📝 填充消息内容                                           │
│     ↓                                                      │
│  📡 发送MQTT消息                                           │
│     ↓                                                      │
│  🔄 消息处理完成                                           │
│     ↓                                                      │
│  🏊 归还对象到池中                                         │
│     │                                                      │
│     ├─ 🔍 重置对象状态                                     │
│     ├─ ❌ 标记为可用                                       │
│     └─ ✅ 对象可重用                                       │
│     ↓                                                      │
│  ✅ 对象池使用完成，避免GC压力                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 场景9: 静态缓存写入 (24-27秒)

```
┌─────────────────────────────────────────────────────────────┐
│                  静态缓存写入流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  💾 [StaticCache] 静态缓存系统                              │
│     │                                                      │
│     ├─ 📁 cache.json: 持久化文件                           │
│     ├─ ⏱️  write_debounce_ms: 5000ms                       │
│     ├─ 🔄 _dirty: 脏标记                                   │
│     └─ 📊 _cache: 内存缓存                                 │
│                                                             │
│  📝 系统状态变更                                           │
│     ↓                                                      │
│  💾 缓存.set('current_state', 'RUNNING')                    │
│     ↓                                                      │
│  🔄 设置脏标记为True                                       │
│     ↓                                                      │
│  ⏱️  启动5秒防抖定时器                                     │
│     │                                                      │
│     ├─ 如果5秒内无新变更 → 写入文件                        │
│     ├─ 如果有新变更 → 重置定时器                           │
│     └─ 📁 ujson.dump() 写入JSON文件                         │
│     ↓                                                      │
│  ✅ 缓存写入完成，避免频繁Flash写入                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 系统健康监控动画

### 场景10: 系统健康检查 (27-30秒)

```
┌─────────────────────────────────────────────────────────────┐
│                  系统健康检查流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🎯 [SystemFSM] RUNNING状态                                │
│     ↓                                                      │
│  ⏱️  每10秒执行健康检查                                    │
│     ↓                                                      │
│  🔍 内存使用检查                                           │
│     │                                                      │
│     ├─ 📊 gc.mem_free() / gc.mem_alloc()                   │
│     ├─ 📈 计算内存使用百分比                               │
│     └─ ⚠️  如果>80% → 发布MEMORY_CRITICAL事件              │
│     ↓                                                      │
│  🌡️  温度检查                                             │
│     │                                                      │
│     ├─ 📡 get_temperature()                                │
│     ├─ 🌡️  获取CPU温度                                     │
│     └─ ⚠️  如果>65°C → 发布SYSTEM_WARNING事件              │
│     ↓                                                      │
│  🐕 看门狗喂狗                                             │
│     │                                                      │
│     ├─ 🕐 重置看门狗计时器                                 │
│     └- ✅ 防止系统死锁                                      │
│     ↓                                                      │
│  📊 系统状态报告                                           │
│     │                                                      │
│     ├- 📝 发布SYSTEM_HEARTBEAT事件                         │
│     ├- 💾 保存状态到缓存                                   │
│     └- ✅ 健康检查完成                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 错误恢复动画

### 场景11: 自动错误恢复 (30-33秒)

```
┌─────────────────────────────────────────────────────────────┐
│                  自动错误恢复流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🎯 当前状态: ERROR                                        │
│     ↓                                                      │
│  📊 错误计数: 3/10                                         │
│     ↓                                                      │
│  ⏱️  15秒恢复等待                                          │
│     ↓                                                      │
│  🔄 开始自动恢复                                           │
│     │                                                      │
│     ├- 🧹 深度垃圾回收 (3次)                               │
│     ├- 🏊 清理对象池                                       │
│     ├- 💾 强制保存缓存                                     │
│     └- 📡 发布RECOVERY_SUCCESS事件                        │
│     ↓                                                      │
│  🎯 状态转换: ERROR → WARNING                              │
│     ↓                                                      │
│  💡 LED模式: blink → pulse                                 │
│     ↓                                                      │
│  📶 [WifiManager] 重新连接WiFi                              │
│     ↓                                                      │
│  📡 [MqttController] 重新连接MQTT                          │
│     ↓                                                      │
│  ✅ 系统恢复到WARNING状态，继续监控                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 系统关机动画

### 场景12: 优雅关机流程 (33-36秒)

```
┌─────────────────────────────────────────────────────────────┐
│                   优雅关机流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🛑 收到关机信号                                           │
│     ↓                                                      │
│  📡 发布SYSTEM_SHUTDOWN事件                                 │
│     ↓                                                      │
│  🎯 [SystemFSM] 状态转换: 任意状态 → SHUTDOWN               │
│     ↓                                                      │
│  💡 [LEDPatternController] LED模式: cruise → off            │
│     ↓                                                      │
│  🧹 开始资源清理                                           │
│     │                                                      │
│     ├- 📡 [MqttController] 断开MQTT连接                    │
│     ├- 📶 [WifiManager] 断开WiFi连接                       │
│     ├- 💡 [LEDPatternController] 清理LED资源               │
│     ├- 💾 [StaticCache] 强制保存缓存                        │
│     └- 🧹 深度垃圾回收                                     │
│     ↓                                                      │
│  ✅ 资源清理完成                                           │
│     ↓                                                      │
│  🛑 状态机主循环停止                                        │
│     ↓                                                      │
│  🔌 系统关机完成                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 总结

### 系统架构特点

1. **事件驱动**: 所有模块通过EventBus松耦合通信
2. **异步处理**: 使用micropython.schedule避免阻塞
3. **状态管理**: 9个状态支持完整系统生命周期
4. **内存优化**: 对象池和静态缓存减少GC压力
5. **错误恢复**: 自动恢复机制和看门狗保护
6. **实时监控**: 内存、温度、连接状态监控

### 关键技术亮点

- **EventBus**: 异步非阻塞，支持频率限制和错误隔离
- **ObjectPool**: 高效对象复用，减少内存分配
- **StaticCache**: 防抖写入，保护Flash存储
- **SystemFSM**: 事件驱动的状态机，支持自动恢复
- **Logger**: 事件驱动的日志系统，支持MQTT集成

### 系统优势

- **高可靠性**: 多重错误恢复机制
- **低资源消耗**: 优化的内存管理策略
- **易于维护**: 模块化设计，松耦合架构
- **实时响应**: 事件驱动，快速状态转换
- **可扩展性**: 易于添加新模块和功能