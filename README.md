# ESP32-C3 物联网设备项目

## 项目概述

这是一个基于ESP32-C3的MicroPython物联网设备项目，专为Home Assistant智能家居系统设计。项目提供WiFi连接、MQTT通信、系统监控和错误恢复等功能，针对资源受限的嵌入式环境进行了优化。

## 项目结构

```
IOT_ESP32C3_HA/
├── src/                          # 源代码目录
│   ├── main.py                   # 主程序入口
│   ├── boot.py                   # 启动脚本
│   ├── config.json               # 配置文件
│   ├── net_wifi.py               # WiFi管理模块
│   ├── net_mqtt.py               # MQTT通信模块
│   ├── sys_daemon.py             # 系统守护进程
│   ├── sys_error.py              # 错误处理模块
│   ├── led_tester.py             # LED测试模块
│   └── lib/                      # 第三方库
│       └── umqtt/
│           └── simple.py         # MQTT客户端库
├── web/                          # Web相关文件
├── public/                       # 公共资源
├── README.md                     # 项目文档
├── CLAUDE.md                     # AI助手指南
└── ISSUE.md                      # 问题分析文档
```

## 核心模块分析

### 1. 主程序 (main.py)

**当前问题：**
- 逻辑过于复杂，包含太多功能模块
- 主循环中存在多重嵌套和复杂的状态管理
- 安全模式处理逻辑混乱，与LED控制冲突
- 看门狗实现不够健壮
- 内存管理策略分散

**主要功能：**
- 系统初始化和配置加载
- WiFi连接管理
- MQTT客户端创建和管理
- 系统监控循环
- 安全模式处理
- LED状态控制

### 2. WiFi管理器 (net_wifi.py)

**功能特点：**
- 多网络支持，按信号强度排序
- 自动网络扫描和连接
- NTP时间同步
- 错误恢复和重试机制

**核心接口：**
- `connect_wifi()` - 连接WiFi
- `set_wifi_networks()` - 设置WiFi网络配置
- `get_wifi_status()` - 获取连接状态

### 3. MQTT客户端 (net_mqtt.py)

**功能特点：**
- 基于umqtt.simple的轻量级实现
- 自动重连机制
- 内存优化的日志发送
- 连接状态监控

**核心接口：**
- `MqttServer` 类 - MQTT客户端封装
- `connect()` - 连接服务器
- `log()` - 发送日志消息
- `check_connection()` - 检查连接状态

### 4. 系统守护进程 (sys_daemon.py)

**功能特点：**
- 系统健康监控（温度、内存、错误计数）
- LED状态控制
- 安全模式管理
- 定时任务执行

**当前问题：**
- LED控制逻辑复杂，存在双重控制冲突
- 定时器回调与主循环存在资源竞争
- 安全模式LED闪烁不稳定

**核心接口：**
- `start_daemon()` - 启动守护进程
- `is_safe_mode()` - 检查安全模式
- `force_safe_mode()` - 强制进入安全模式
- `get_daemon_status()` - 获取系统状态

### 5. 错误处理系统 (sys_error.py)

**功能特点：**
- 统一错误分类和处理
- 智能恢复策略
- 内存友好的日志缓冲
- 错误统计和分析

**核心接口：**
- `handle_error()` - 处理错误
- `get_error_stats()` - 获取错误统计
- `set_log_level()` - 设置日志级别

### 6. LED测试模块 (led_tester.py)

**功能特点：**
- 多种预设LED闪烁模式
- 独立的测试功能
- 硬件验证工具

**预设模式：**
- 快闪三下
- 一长两短
- SOS求救信号
- 心跳模式
- 警灯模式
- 呼吸灯模式

## 配置系统

### config.json 结构

```json
{
  "mqtt": {
    "broker": "192.168.3.15",
    "port": 1883,
    "topic": "lzs/esp32c3",
    "keepalive": 60
  },
  "wifi": {
    "networks": [
      {"ssid": "zsm60p", "password": "25845600"}
    ],
    "config": {
      "timeout": 15,
      "scan_interval": 30
    }
  },
  "daemon": {
    "config": {
      "led_pins": [12, 13],
      "monitor_interval": 5000,
      "temp_threshold": 65,
      "memory_threshold": 80
    }
  },
  "system": {
    "main_loop_delay": 300,
    "status_report_interval": 30
  }
}
```

## 系统工作流程

### 正常启动流程

1. **boot.py** → 垃圾回收初始化
2. **main.py** → 系统初始化
3. **配置加载** → 读取config.json
4. **WiFi连接** → 连接最优网络
5. **时间同步** → NTP同步时间
6. **MQTT连接** → 连接MQTT代理
7. **守护进程启动** → 开始系统监控
8. **主循环** → 持续运行和监控

### 主循环任务

1. **看门狗喂狗** → 防止系统死锁
2. **内存监控** → 智能垃圾回收
3. **状态报告** → 定期发送系统状态
4. **连接检查** → 检查WiFi和MQTT连接
5. **安全模式处理** → 处理异常状态

### 错误处理流程

1. **错误发生** → 错误分类和记录
2. **严重程度判断** → 确定处理优先级
3. **恢复动作执行** → 尝试自动恢复
4. **系统保护** → 必要时进入安全模式
5. **日志记录** → 记录错误和恢复过程

## 当前问题分析

### 1. LED控制冲突 ⚠️

**问题描述：**
- 守护进程定时器和主循环同时控制LED
- 安全模式LED闪烁不稳定
- 状态管理混乱

**影响：** 安全模式指示功能失效

### 2. 主循环过于复杂 ⚠️

**问题描述：**
- 主循环包含太多逻辑分支
- 安全模式处理与正常模式混合
- 状态管理不清晰

**影响：** 代码维护困难，bug难以定位

### 3. 内存管理分散 ⚠️

**问题描述：**
- 垃圾回收策略分散在多个模块
- 内存监控逻辑不统一
- 缺乏统一的内存管理策略

**影响：** 系统稳定性受影响

### 4. 错误恢复机制不够健壮 ⚠️

**问题描述：**
- 某些错误类型的恢复策略不够完善
- 错误统计和阈值设置需要优化
- 恢复动作的成功率有待提高

**影响：** 系统自愈能力有限

## 硬件资源

### ESP32-C3 规格
- **内存：** 264KB SRAM
- **存储：** 4MB Flash
- **处理器：** RISC-V 双核 32位
- **无线：** WiFi 802.11b/g/n
- **GPIO：** 22个数字IO引脚
- **接口：** SPI, I2C, UART, ADC

### 引脚分配
- **LED1：** GPIO 12
- **LED2：** GPIO 13
- **看门狗：** 软件实现

## 部署和使用

### 文件上传到设备

```bash
# 使用rshell上传文件
rshell cp src/boot.py /pyboard/boot.py
rshell cp src/config.py /pyboard/config.py
rshell cp src/main.py /pyboard/main.py
rshell cp src/config.json /pyboard/config.json
# ... 其他文件
```

### 设备测试

通过串口监控设备输出：
- WiFi连接状态
- MQTT连接状态
- 内存使用报告
- 系统日志
- LED状态指示

## 优化方向

### 1. 代码重构
- 简化主循环逻辑
- 分离安全模式处理
- 统一LED控制接口
- 优化状态管理

### 2. 内存优化
- 统一内存管理策略
- 优化数据结构
- 减少内存碎片
- 改进垃圾回收

### 3. 错误处理增强
- 完善恢复策略
- 优化错误分类
- 改进日志系统
- 增强自愈能力

### 4. 功能扩展
- 蓝牙功能重构
- 传感器集成
- 本地控制接口
- 远程管理功能

## 维护说明

### 日常维护
- 定期检查错误日志
- 监控内存使用情况
- 更新配置文件
- 备份重要数据

### 故障排除
1. 查看串口输出日志
2. 检查WiFi和MQTT连接
3. 验证配置文件正确性
4. 测试LED硬件功能
5. 分析错误统计信息

### 性能监控
- 内存使用率
- 错误发生频率
- 网络连接稳定性
- 系统响应时间

---

**注意：** 本项目针对ESP32-C3的264KB内存限制进行了优化，在功能丰富性和资源消耗之间取得了平衡。所有模块都考虑了嵌入式环境的特殊要求。