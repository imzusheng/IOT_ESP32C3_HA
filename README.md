

## 设备信息

```bash
Chip is ESP32-C3 (QFN32) (revision v0.4)
Features: Wi-Fi, BT 5 (LE), Single Core, 160MHz
Crystal is 40MHz
MAC: 50787df23340
Manufacturer: 68
Device: 4016
Status value: 0x400000
Detected flash size: 4MB
```

## 代码分析

### 项目概述

这是一个基于ESP32-C3的MicroPython守护程序，实现了双LED呼吸灯效果，并具备完整的系统监控和安全保护机制。程序版本为V3.2，具有高度的稳定性和安全性。

### 主要功能

#### 1. 双LED呼吸灯控制
- **硬件配置**: 使用GPIO 12和13控制两个LED
- **PWM控制**: 1000Hz频率，最大亮度限制为60%（20000/65535）
- **呼吸效果**: 两个LED亮度互补变化，创造平滑的呼吸灯效果
- **可调参数**: 亮度步长256，主循环延迟100ms

#### 2. 系统监控
- **运行时间统计**: 精确到毫秒的运行时间追踪
- **内存监控**: 实时监控内存分配和使用率
- **温度监控**: 持续监控MCU内部核心温度
- **性能报告**: 每10秒输出详细的系统状态面板

#### 3. 安全保护机制
- **温度保护**: 当MCU温度超过60°C时自动进入安全模式
- **看门狗保护**: 30秒超时的硬件看门狗，防止系统死锁
- **安全模式**: 温度超限时停止PWM，切换为GPIO爆闪报警
- **自动恢复**: 温度降至安全范围后自动退出安全模式

### 代码架构

#### 配置常量区
```python
# LED引脚定义
LED_PIN_1 = 12
LED_PIN_2 = 13

# PWM呼吸灯效果配置
PWM_FREQ = 1000
MAX_BRIGHTNESS_U16 = 20000
FADE_STEP = 256
MAIN_LOOP_DELAY_MS = 100

# 安全模式配置
TEMPERATURE_THRESHOLD = 60.0
WDT_TIMEOUT_MS = 30000
```

#### 核心功能模块

1. **辅助功能函数**
   - `format_uptime()`: 时间格式化（毫秒转D-H-M-S格式）
   - `print_startup_banner()`: 详细的启动信息显示
   - `get_internal_temperature()`: MCU温度读取

2. **安全模式管理**
   - `enter_safe_mode()`: 进入安全模式，释放PWM资源
   - `exit_safe_mode()`: 退出安全模式，重新初始化PWM
   - `safe_mode_loop()`: 安全模式下的爆闪报警循环
   - `check_system_recovery()`: 检查系统恢复条件

3. **主程序循环**
   - 状态监控和安全检查
   - PWM亮度控制和呼吸效果
   - 看门狗喂养
   - 定期性能报告

### 安全特性

#### 温度保护机制
- **阈值设定**: 60°C触发保护，55°C解除保护（5°C滞后防抖）
- **保护动作**: 立即停止PWM输出，切换为GPIO控制
- **报警方式**: 双LED交替爆闪（200ms间隔）
- **冷却时间**: 5秒最小安全模式停留时间

#### 看门狗机制
- **超时时间**: 30秒（为安全模式预留充足时间）
- **喂养频率**: 正常模式每秒一次，安全模式每2秒一次
- **异常处理**: 系统死锁时自动重启

### 系统信息显示

程序启动时会显示详细的系统信息：
- 固件版本和实现信息
- 硬件唯一ID和CPU频率
- 文件系统容量和可用空间
- 运行时状态面板（每10秒更新）

### 错误处理

- **异常捕获**: 所有关键操作都有try-catch保护
- **优雅降级**: PWM失败时不影响系统监控
- **自动恢复**: 主循环异常时暂停1秒后继续
- **资源管理**: 安全模式下正确释放和重新分配资源

### 性能优化

- **内存管理**: 定期执行垃圾回收，监控内存使用
- **CPU效率**: 合理的循环延迟，避免过度占用CPU
- **资源复用**: PWM对象的安全初始化和释放
- **状态缓存**: 避免重复的状态检查和计算

### 使用说明

1. **硬件连接**: 将LED连接到GPIO 12和13
2. **上传代码**: 将main.py上传到ESP32-C3的根目录
3. **启动运行**: 设备上电后自动运行
4. **监控状态**: 通过串口查看系统状态和报告
5. **安全保护**: 系统会自动处理温度异常情况

### 技术特点

- **高可靠性**: 多层安全保护机制
- **实时监控**: 全面的系统状态追踪
- **用户友好**: 详细的中文状态信息
- **可维护性**: 清晰的代码结构和注释
- **扩展性**: 模块化设计便于功能扩展