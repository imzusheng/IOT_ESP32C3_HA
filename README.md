# ESP32C3-IOT 物联网设备

## 📋 项目简介

这是一个基于ESP32-C3的MicroPython物联网设备项目，专为Home Assistant智能家居系统设计。项目采用模块化架构，提供WiFi连接、MQTT通信、系统监控、LED状态指示和错误恢复等功能，确保设备在资源受限的嵌入式环境中稳定运行。

### 🎯 项目目标

- 为Home Assistant提供稳定可靠的物联网设备接入
- 实现低内存占用的优化设计（ESP32C3仅有264KB内存）
- 提供完整的设备监控和错误恢复机制
- 支持Web蓝牙配置界面，简化设备设置流程

## ✨ 功能特性

### 🔧 核心功能
- **多网络WiFi支持**: 自动扫描并连接信号最强的配置网络
- **MQTT通信**: 高效的MQTT客户端，支持自动重连和内存优化
- **系统监控**: 实时监控温度、内存使用和系统健康状态
- **错误恢复**: 智能错误处理和自动恢复机制
- **内存管理**: 优化的垃圾回收策略，适合ESP32C3的264KB内存限制
- **看门狗保护**: 防止系统死锁，确保设备稳定运行
- **LED状态指示**: 通过LED显示设备运行状态，支持多种预设模式
- **配置管理**: 灵活的配置系统，支持运行时验证

### 🚀 高级功能
- **状态机管理**: 清晰的系统状态管理和事件驱动的状态转换
- **对象池系统**: 高效的对象池和缓存管理，减少内存分配开销
- **恢复管理器**: 集中化的错误恢复策略管理，支持分级恢复
- **Web配置界面**: 基于Web Bluetooth的现代化配置界面
- **内存优化器**: 智能内存监控和优化策略

## 🛠️ 技术栈和硬件要求

### 硬件要求
- **主控芯片**: ESP32-C3
- **内存**: 264KB SRAM
- **存储**: 4MB Flash
- **处理器**: RISC-V 双核 32位
- **无线**: WiFi 802.11b/g/n
- **GPIO**: 22个数字IO引脚
- **接口**: SPI, I2C, UART, ADC

### 引脚分配
- **LED1**: GPIO 12
- **LED2**: GPIO 13
- **看门狗**: 软件实现

### 软件技术栈
- **编程语言**: MicroPython
- **网络协议**: WiFi 802.11b/g/n, MQTT
- **依赖库**:
  - `umqtt.simple`: 轻量级MQTT客户端库
  - MicroPython标准库: network, time, machine, ntptime, gc
- **Web技术**: HTML5, CSS3, JavaScript ES6+, Web Bluetooth API

## 📁 项目结构

```
IOT_ESP32C3/
├── src/                          # 源代码目录
│   ├── boot.py                   # 启动脚本
│   ├── main.py                   # 主应用程序
│   ├── config_manager.py         # 配置管理器
│   ├── config.json               # 运行时配置文件
│   ├── sys_daemon.py             # 系统守护进程
│   └── lib/                      # 库文件目录
│       ├── net_wifi.py           # WiFi网络管理
│       ├── net_mqtt.py           # MQTT客户端
│       ├── sys_error.py          # 错误处理系统
│       ├── led_preset.py         # LED预设管理
│       ├── state_machine.py      # 状态机管理
│       ├── mem_optimizer.py      # 内存优化器和对象池
│       ├── recovery_manager.py   # 恢复管理器
│       ├── utils.py              # 工具函数
│       └── umqtt/
│           └── simple.py         # MQTT客户端库
├── web/                          # Web配置界面
│   ├── index.html                # 主页面
│   └── README_WEB.md             # Web界面文档
├── public/                       # 公共文件
│   └── mosquitto-2.0.22-install-windows-x64.exe
├── .gitignore                    # Git忽略文件
├── CLAUDE.md                     # 项目分析文档
└── README.md                     # 项目说明文档（本文件）
```

## 🚀 安装和设置指南

### 1. 环境准备

#### 硬件准备
- ESP32-C3开发板
- LED指示灯（可选）
- USB数据线

#### 软件准备
- MicroPython固件（ESP32-C3版本）
- rshell或其他文件传输工具
- 支持Web Bluetooth API的现代浏览器（Chrome、Edge、Opera）

### 2. 固件烧录

1. 下载ESP32-C3的MicroPython固件
2. 使用esptool工具烧录固件：
   ```bash
   esptool.py --chip esp32c3 --port COMx erase_flash
   esptool.py --chip esp32c3 --port COMx --baud 460800 write_flash -z 0x0 firmware.bin
   ```

### 3. 文件部署

使用rshell部署项目文件：

```bash
# 连接设备
rshell --port COMx

# 部署文件
cp src/boot.py /pyboard/boot.py
cp src/config_manager.py /pyboard/config_manager.py
cp src/main.py /pyboard/main.py
cp src/config.json /pyboard/config.json
cp src/sys_daemon.py /pyboard/sys_daemon.py
cp -r src/lib/ /pyboard/lib/
```

### 4. 初始配置

#### 方法一：通过Web界面配置
1. 在支持的浏览器中打开 `web/index.html`
2. 通过蓝牙连接ESP32-C3设备
3. 配置WiFi网络和MQTT服务器参数
4. 保存配置并重启设备

#### 方法二：直接编辑配置文件
编辑 `src/config.json` 文件，配置以下参数：

```json
{
  "mqtt": {
    "broker": "192.168.1.2",
    "port": 1883,
    "topic": "lzs/esp32c3",
    "keepalive": 60
  },
  "wifi": {
    "networks": [
      {"ssid": "your_wifi_ssid", "password": "your_wifi_password"}
    ]
  },
  "device": {
    "name": "ESP32C3-IOT",
    "location": "客厅",
    "firmware_version": "1.0.0"
  }
}
```

## 📖 使用说明

### 1. 设备启动流程

设备启动后会按照以下流程运行：
1. **初始化**: 加载配置，初始化系统模块
2. **网络连接**: 扫描并连接最优WiFi网络
3. **时间同步**: 通过NTP同步系统时间
4. **MQTT连接**: 连接到MQTT代理服务器
5. **系统监控**: 启动守护进程，开始系统监控
6. **主循环**: 进入正常运行状态

### 2. 状态指示

设备通过LED指示当前运行状态：
- **正常模式**: LED稳定亮起或缓慢闪烁
- **警告模式**: LED中等频率闪烁
- **错误模式**: LED快速闪烁
- **安全模式**: LED特定模式闪烁（如SOS模式）

### 3. Web配置界面使用

#### 浏览器要求
- ✅ Google Chrome（推荐）
- ✅ Microsoft Edge
- ✅ Opera
- ❌ Firefox（不支持Web Bluetooth API）
- ❌ Safari（iOS版不支持Web Bluetooth API）

#### 使用步骤
1. 打开 `web/index.html`
2. 点击"连接设备"按钮，选择ESP32-C3设备
3. 配置WiFi网络和MQTT参数
4. 设置设备基本信息
5. 保存配置并重启设备

### 4. 系统监控

设备会定期向MQTT主题发送系统状态信息：
- 内存使用情况
- 温度监控
- 网络连接状态
- MQTT连接状态
- 系统运行时间

## 🏗️ 系统架构概述

### 核心架构设计

项目采用模块化架构设计，各模块职责明确，相互协作：

```
┌─────────────────────────────────────────────────────────────┐
│                    主应用程序 (main.py)                      │
├─────────────────────────────────────────────────────────────┤
│  配置管理  │  网络管理  │  系统监控  │  错误处理  │  状态管理  │
├─────────────────────────────────────────────────────────────┤
│  WiFi连接  │  MQTT通信  │  LED控制  │  内存管理  │  恢复管理  │
├─────────────────────────────────────────────────────────────┤
│                    硬件抽象层 (MicroPython)                 │
└─────────────────────────────────────────────────────────────┘
```

### 系统状态机

设备运行状态通过状态机管理：
- **INIT**: 初始化状态
- **NETWORKING**: 网络连接状态
- **RUNNING**: 正常运行状态
- **WARNING**: 警告状态
- **ERROR**: 错误状态
- **SAFE_MODE**: 安全模式
- **RECOVERY**: 恢复状态
- **SHUTDOWN**: 关机状态

### 主循环流程

```
喂狗 → 内存监控 → 守护进程状态检查 → 安全模式判断 → 
MQTT连接检查 → LED状态检查 → 状态报告 → 延迟
```

## 🔧 模块说明

### 1. 主应用程序 (main.py)

**功能**: 系统主控制中心，协调各模块运行

**主要职责**:
- 实现主循环、内存管理和看门狗喂狗
- 集成配置管理器、WiFi连接、MQTT通信和守护进程
- LED状态指示和系统监控功能
- 状态机管理和错误恢复协调

### 2. 配置管理器 (config_manager.py)

**功能**: 集中式配置管理，使用类常量定义所有参数

**主要特性**:
- 配置验证器，启动时自动验证配置有效性
- 分模块配置：MQTTConfig、WiFiConfig、DaemonConfig、SystemConfig
- 内存优化：避免JSON文件，减少I/O操作

### 3. WiFi管理器 (lib/net_wifi.py)

**功能**: 健壮的WiFi连接管理，支持多网络选择

**主要特性**:
- 自动网络扫描和RSSI-based排序
- NTP时间同步和时区设置
- 连接超时处理和错误恢复

### 4. MQTT客户端 (lib/net_mqtt.py)

**功能**: 基于umqtt.simple的自定义MQTT包装器

**主要特性**:
- 连接管理和自动重连机制
- 内存优化的日志发送（使用bytearray）
- 心跳监控和连接状态跟踪

### 5. 系统守护进程 (sys_daemon.py)

**功能**: 系统监控和安全保护功能

**主要特性**:
- LED状态指示控制
- 温度监控和安全模式
- 内存监控和垃圾回收
- 系统健康检查和错误恢复

### 6. 错误处理器 (lib/sys_error.py)

**功能**: 统一错误处理和日志管理

**主要特性**:
- 智能错误分类和恢复机制
- 内存友好的日志缓冲
- 自动错误恢复和系统重启

**错误类型分类**:
- **NETWORK**: 网络连接错误
- **HARDWARE**: 硬件故障
- **MEMORY**: 内存不足
- **CONFIG**: 配置错误
- **SYSTEM**: 系统错误
- **MQTT**: MQTT通信错误
- **WIFI**: WiFi连接错误
- **DAEMON**: 守护进程错误
- **FATAL**: 致命错误

### 7. LED预设管理器 (lib/led_preset.py)

**功能**: 统一的LED状态指示管理

**主要特性**:
- 多种预设闪烁模式（快闪三下、SOS、心跳等）
- 系统状态可视化（正常、警告、错误、安全模式）
- 单例模式设计，避免重复初始化

### 8. 状态机 (lib/state_machine.py)

**功能**: 清晰的系统状态管理

**主要特性**:
- 事件驱动的状态转换
- 支持多种系统状态
- 状态历史记录和监控

### 9. 内存优化器 (lib/mem_optimizer.py)

**功能**: 高效的内存优化和对象池管理

**主要特性**:
- 字典对象池、字符串缓存、缓冲区管理
- 内存监控和智能清理策略
- 减少内存分配和垃圾回收开销

### 10. 工具函数 (lib/utils.py)

**功能**: 通用工具函数集合

**主要特性**:
- 系统信息获取（温度、内存使用情况）
- 配置值获取和格式化
- 内存检查和优化功能

### 11. 恢复管理器 (lib/recovery_manager.py)

**功能**: 集中化的错误恢复策略管理

**主要特性**:
- 分级恢复动作：网络、内存、服务、系统、硬件恢复
- 恢复成功率统计和冷却时间管理
- 智能恢复调度和错误处理

**恢复策略**:
- **网络恢复**: WiFi重连 + MQTT重连
- **内存恢复**: 深度清理 + 对象池重建
- **服务恢复**: 守护进程重启
- **系统恢复**: 状态机管理 + 安全模式
- **硬件恢复**: 系统重启

## 🌐 Web配置界面说明

### 概述

Web配置界面采用Apple设计风格，提供简洁、优雅的用户体验。通过蓝牙连接设备，支持WiFi、MQTT和设备配置的完整管理。

### 主要功能

#### 1. 蓝牙连接管理
- **自动检测功能**: 页面加载时自动检测蓝牙支持情况
- **实时状态监控**: 监听蓝牙可用性变化，自动更新连接状态
- **连接状态显示**: 固定状态指示器显示连接状态
  - 🟢 绿色：已连接
  - 🔴 红色：未连接
  - 🟠 橙色：扫描中

#### 2. WiFi配置
- **网络扫描**: 自动扫描可用WiFi网络
- **网络信息显示**: 显示网络名称、加密类型、信号强度等
- **网络管理**: 添加、删除和选择WiFi网络

#### 3. MQTT配置
- **服务器配置**: 设置MQTT broker地址、端口、主题等
- **连接参数**: 配置心跳间隔、重连延迟等
- **配置验证**: 自动验证配置参数的有效性

#### 4. 设备配置
- **基本信息**: 设置设备名称、位置等
- **系统设置**: 配置日志级别、调试模式等
- **系统操作**: 重启设备、恢复出厂设置

### 技术特性

- **Web Bluetooth API**: 使用现代Web蓝牙技术
- **实时通信**: 支持双向数据交换和状态更新
- **安全连接**: 加密的蓝牙通信
- **自动重连**: 蓝牙状态变化时的自动处理

### 蓝牙服务配置

```javascript
// 蓝牙服务UUID
const SERVICE_UUID = '00001234-0000-1000-8000-00805f9b34fb';

// 特征值UUID
const CHAR_CONFIG_UUID = '00001235-0000-1000-8000-00805f9b34fb';    // 配置读写
const CHAR_STATUS_UUID = '00001236-0000-1000-8000-00805f9b34fb';     // 状态通知
const CHAR_WIFI_SCAN_UUID = '00001237-0000-1000-8000-00805f9b34fb';  // WiFi扫描
const CHAR_WIFI_LIST_UUID = '00001238-0000-1000-8000-00805f9b34fb'; // WiFi列表
const CHAR_DEVICE_INFO_UUID = '00001239-0000-1000-8000-00805f9b34fb'; // 设备信息
```

## 🔍 故障排除

### 常见问题

#### 1. 设备无法启动
**可能原因**:
- 固件烧录失败
- 配置文件错误
- 硬件连接问题

**解决方案**:
1. 检查串口连接是否正常
2. 重新烧录MicroPython固件
3. 验证配置文件格式是否正确
4. 查看串口日志获取详细错误信息

#### 2. WiFi连接失败
**可能原因**:
- WiFi网络不可用
- 配置的WiFi信息错误
- 信号强度不足

**解决方案**:
1. 确认WiFi网络正常工作
2. 检查WiFi配置是否正确
3. 尝试靠近路由器增强信号
4. 通过Web界面重新配置WiFi

#### 3. MQTT连接失败
**可能原因**:
- MQTT服务器不可达
- 配置参数错误
- 网络连接问题

**解决方案**:
1. 检查MQTT服务器是否正常运行
2. 验证MQTT配置参数（地址、端口、主题）
3. 确认网络连接正常
4. 查看设备日志获取MQTT连接状态

#### 4. Web蓝牙连接失败
**可能原因**:
- 浏览器不支持Web Bluetooth API
- 设备蓝牙未开启或不可被发现
- 蓝牙服务配置错误

**解决方案**:
1. 使用支持的浏览器（Chrome、Edge、Opera）
2. 确认设备蓝牙功能正常
3. 检查设备蓝牙服务是否正确广播
4. 尝试重启设备和浏览器

#### 5. 内存不足问题
**可能原因**:
- 内存泄漏
- 配置过于复杂
- 系统运行时间过长

**解决方案**:
1. 监控内存使用情况（通过串口日志）
2. 简化配置，减少不必要的功能
3. 重启设备释放内存
4. 检查代码是否有内存泄漏

### 调试技巧

#### 1. 串口调试
通过串口连接设备，查看详细日志信息：
```bash
# 使用rshell连接
rshell --port COMx
# 查看REPL
repl
```

#### 2. 内存监控
设备会定期输出内存使用情况：
```
[INFO] 内存使用: 45% (可用: 145KB)
[INFO] 温度: 52.3°C
```

#### 3. LED状态指示
观察LED闪烁模式，判断设备当前状态：
- 稳定亮起：正常运行
- 慢速闪烁：警告状态
- 快速闪烁：错误状态
- SOS模式：安全模式

#### 4. Web界面调试
使用浏览器开发者工具调试Web界面：
1. 按F12打开开发者工具
2. 查看Console标签页的错误信息
3. 使用Network标签页监控蓝牙通信
4. 检查Application标签页的本地存储

### 系统恢复

#### 1. 软重启
通过Web界面或串口发送重启命令：
```javascript
// Web界面重启
const command = JSON.stringify({ cmd: 'device_restart' });
await configCharacteristic.writeValue(new TextEncoder().encode(command));
```

#### 2. 恢复出厂设置
清除所有配置并重启：
```javascript
// 恢复出厂设置
const command = JSON.stringify({ cmd: 'factory_reset' });
await configCharacteristic.writeValue(new TextEncoder().encode(command));
```

#### 3. 手动重置
1. 断开设备电源
2. 按住BOOT按钮
3. 连接电源
4. 释放BOOT按钮，设备将恢复到初始状态

## 📄 许可证信息

本项目采用MIT许可证。详情请参阅LICENSE文件。

### MIT许可证

版权所有 (c) 2024 ESP32C3-IOT项目

特此免费授予任何获得本软件及相关文档文件（"软件"）副本的人不受限制地处理软件的权利，包括但不限于使用、复制、修改、合并、发布、分发、再许可和/或销售软件副本的权利，并允许获得软件的人这样做，但须符合以下条件：

上述版权声明和本许可声明应包含在软件的所有副本或实质性部分中。

本软件按"原样"提供，不提供任何形式的明示或暗示的保证，包括但不限于适销性、特定用途的适用性和非侵权性的保证。在任何情况下，作者或版权持有人均不对因软件或软件的使用或其他交易而产生的任何索赔、损害或其他责任承担责任，无论是在合同、侵权还是其他方面。

---

**项目维护者**: ESP32C3-IOT开发团队  
**最后更新**: 2025-08-06  
**版本**: v2.0.0