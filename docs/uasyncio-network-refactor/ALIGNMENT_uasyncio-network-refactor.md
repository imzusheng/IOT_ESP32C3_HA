# ALIGNMENT_uasyncio-network-refactor

目标: 引入 uasyncio 重构网络编排, 去除主循环中的长时阻塞, 提升系统稳定性与实时性, 与现有架构与风格一致, 删除旧同步逻辑与注释。

## 现状与问题
- 阻塞点
  - WiFi 连接阶段存在阻塞等待与较长 sleep 切片, 会卡住主循环与 LED 更新, 影响看门狗喂狗。
  - MQTT 连接与连接验证使用同步 socket 操作, 单次超时较长, 在网络不畅时阻塞明显。
  - NTP 同步为一次性阻塞调用, 但已不阻塞后续 MQTT, 影响较小。
- 架构耦合
  - NetworkManager.loop() 负责编排 WiFi,NTP,MQTT 的同步推进, FSM 通过事件响应状态, 主循环每 100ms 驱动一次。
  - umqtt 使用非阻塞 check_msg() 已较好, 但 connect() 仍为同步。
- 结果
  - 当网络异常时, 主线程任务延迟或停顿, 触发 FSM 阶段超时转 ERROR, 出现周期性“错误状态超时()”日志。

## 重构动机与收益
- 治本去阻塞: 使用 uasyncio 将网络操作拆分为小步协作, 单次等待使用短超时与让出执行权。
- 稳定与实时: LED 更新, 看门狗, 事件总线与状态机更新不再被网络卡住。
- 容错增强: 以任务为单位的取消, 超时与指数退避更加清晰。

## 范围与优先级
- P0 结构搭建
  - 引入 Async 主循环框架与任务管理, 以适配现有 EventBus,FSM。
- P1 网络协程化
  - WiFi 扫描与连接流程改为可重入的协程推进。
  - MQTT 连接, 维持与消息处理协程化, 连接验证分阶段小超时推进。
  - NTP 同步放入独立低优先级任务, 失败快速返回。
- P2 强化与清理
  - 删除同步 loop 驱动点, 替换为调度任务。
  - 增加可观测性与超时参数化。

## 风险与约束
- 资源约束: ESP32C3 内存有限, 任务数量与栈占用需受控。
- 依赖: 使用 MicroPython 自带 uasyncio, 禁止引入沉重第三方库。
- 约束: 不允许运行 app/ 下文件, 每阶段必须 /build.py -c 通过。

## 验收标准
- 功能完整
  - 正常网络环境下, 系统启动后能够扫描 WiFi, 连接, 同步 NTP, 连接 MQTT, 订阅与发布工作正常。
- 实时性
  - 在网络异常情况下, 主循环协作任务仍按期执行, LED 持续更新, 看门狗正常喂狗。
- 非阻塞
  - WiFi 与 MQTT 连接阶段均拆为小步推进, 单次等待不超过 200ms 可配置, 不出现长达数秒的同步阻塞。
- 稳定性
  - 指数退避与最大重试遵循配置, FSM 事件流保持一致。
- 编译通过
  - 每阶段改造后 /build.py -c 通过。

## 非目标
- 不更换 MQTT 客户端库, 优先在现有 umqtt 基础上做协作式封装。
- 不引入线程或多进程。

## 清理与移除
- 不保留旧同步网络编排逻辑与相关注释, 全量迁移至异步实现。

## 基线指标与观察
- 启动至 MQTT 连接成功的总时长。
- 在网络不可达时, LED 是否持续更新, 主循环是否卡顿。
- 错误状态超时日志的出现频率应显著下降。