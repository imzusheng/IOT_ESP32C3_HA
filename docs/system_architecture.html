<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>系统架构图</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        .mermaid { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <h1>系统架构图</h1>
    <p>右键点击图表 -> 图片另存为 (Save image as) -> 选择SVG格式</p>

    <h2>系统组件交互图</h2>
    <div class="mermaid">
graph TD
    subgraph 系统组件交互图
        A[MainController] -->|创建| B(EventBus)
        A -->|创建并注入EventBus| C(NetworkManager)
        A -->|开箱即用| D(LED模式控制器)
        A -->|创建并注入所有依赖| E(Finite State Machine - FSM)

        C -- "发布 (例如 WIFI_STATE_CHANGE)" --> B
        B -- "通知 (调用回调)" --> E
        E -- "调用 (例如 start_connection)" --> C
        E -- "调用 (例如 play_pattern)" --> D
    end
    </div>

    <h2>FSM与事件总线协作流程</h2>
    <div class="mermaid">
graph TD
    direction LR
    
    subgraph 外部世界
        HW[硬件/网络模块 例如 NetworkManager]
    end

    subgraph 系统核心
        EB(EventBus)
        FSM_Core[FSM Core]
        SH[State Handlers]
    end

    HW -- "发布事件\n 例如 event_bus.publish" --> EB
    EB -- "定时器轮询\n 从队列取出事件" --> EB
    EB -- "调用已订阅的回调\n fsm._handle_event" --> FSM_Core
    FSM_Core -- "转换外部事件为内部事件\n 'wifi.state_change' -> 'wifi_connected'" --> FSM_Core
    FSM_Core -- "查找状态转换规则\n (NETWORKING, 'wifi_connected') -> RUNNING" --> FSM_Core
    FSM_Core -- "调用新旧状态的Handler\n exit_networking(), enter_running()" --> SH
    SH -- "执行具体操作\n 例如 network_manager.start_services()" --> HW
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

</body>
</html>