# 4A-REFACTOR: Hz性能显示移除 & 日志级别优化 & MQTT重连增强

## 问题描述

基于用户反馈和代码分析，识别出三个需要优化的问题：

### 1. 性能Hz显示毫无意义（关键问题）
- **现象**: 日志中 `性能:10.0Hz` 的显示，基于主循环频率计算
- **位置**: `app/main.py:165-172` (计算逻辑) 和 `183-184` (日志输出)
- **问题**: 用户认为此指标毫无意义，应该完全移除
- **影响**: 冗余的性能统计占用CPU和内存资源

### 2. INFO日志过于密集（重要问题）
- **现象**: 系统运行中INFO级别日志过多，影响关键信息识别
- **范围**: FSM状态转换、网络连接状态、LED操作等
- **期望**: 将非关键操作日志降级为DEBUG，保留重要节点为INFO

### 3. MQTT重连机制分析
- **现状**: 从`network_manager.py:360-383`可见已有重连检测逻辑
- **机制**: `_check_mqtt_status()`检测连接丢失后发布事件，FSM响应重连
- **问题**: 需要验证重连是否具有合理的延迟和重试策略

## 根因分析

### Hz性能显示问题
1. **设计初衷**: 原本用于监控主循环执行频率
2. **实际价值**: 对于IoT设备，主循环频率并非关键性能指标
3. **资源消耗**: 每30秒进行一次计算和统计，消耗不必要的CPU

### 日志级别问题
1. **当前现状**: 大多数操作日志使用INFO级别
2. **实际需求**: 运行时只需要关注关键状态变更和错误
3. **调试困难**: 重要信息被淹没在大量操作日志中

### MQTT重连机制
1. **已有机制**: 网络管理器具备状态检测和事件发布能力
2. **FSM响应**: 状态机能响应MQTT断开事件并触发重连
3. **待验证**: 重连频率是否合理，是否有退避机制

## 重构目标

### 核心目标
1. **完全移除Hz性能显示**: 删除所有相关计算和日志输出
2. **优化日志级别**: 将非关键操作降级为DEBUG，保留重要事件为INFO
3. **增强MQTT重连**: 确保重连机制健壮且具有合理的重试策略

### 验收标准
1. **Hz显示移除**: 系统状态日志不再包含性能Hz信息
2. **日志优化**: INFO日志明显减少，关键信息更突出
3. **MQTT重连**: 连接失败后能自动重连，有合理的重试间隔
4. **编译通过**: `/build.py -c` 成功通过
5. **功能完整**: 所有现有功能保持不变

## 风险与约束

### 低风险变更
- Hz性能计算移除：纯统计逻辑，不影响系统运行
- 日志级别调整：不改变程序逻辑，仅调整输出

### 中等风险
- MQTT重连逻辑调整：需要确保不破坏现有连接机制

### 约束条件
- 必须保持现有架构和代码风格
- 不允许引入新的外部依赖
- 必须确保向后兼容性
- 渐进式修改，每步都可验证

## 实施范围

### 主要修改文件
- `app/main.py`: 移除Hz计算逻辑，优化系统状态日志
- `app/fsm/core.py`: 调整状态转换日志级别
- `app/net/network_manager.py`: 优化连接操作日志，增强重连逻辑
- `app/net/mqtt.py`: 调整连接相关日志级别
- `app/hw/led.py`: 调整LED操作日志级别

### 不涉及修改
- 事件总线核心逻辑
- 配置系统
- 硬件抽象层基础功能

## 详细分析

### Hz性能显示相关代码位置
```python
# app/main.py:165-172 - 计算逻辑
if self.last_stats_time == 0:
    self.last_stats_time = current_time
    loops = self.loop_count
    freq_hz = (loops / 30.0) if loops else 0.0
else:
    time_window_ms = time.ticks_diff(current_time, self.last_stats_time)
    time_window_s = time_window_ms / 1000.0 if time_window_ms > 0 else 1.0
    loops = self.loop_count
    freq_hz = loops / time_window_s if time_window_s > 0 else 0.0

# app/main.py:183-184 - 日志输出
info("系统状态 - 状态:{}, 内存:{}KB({:.0f}%), 性能:{:.1f}Hz, WiFi:{}, MQTT:{}", 
     state, free_kb, percent_used, freq_hz, ...)
```

### 需要调整日志级别的典型场景
- LED操作确认
- 网络连接步骤详情
- 状态机内部转换过程
- 事件总线消息处理详情

### MQTT重连机制现状
- `network_manager._check_mqtt_status()` 检测连接状态
- 连接丢失时发布 `MQTT_STATE_CHANGE` 事件
- FSM响应事件并触发重连流程
- 需要确认是否有适当的重试间隔