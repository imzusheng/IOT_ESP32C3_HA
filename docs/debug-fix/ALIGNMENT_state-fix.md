# 3A工作流 - 问题对齐文档
## FSM状态修复 + 内存显示优化

### 问题概述

基于运行日志分析，发现当前FSM状态机存在旧代码遗留问题，同时内存显示格式需要优化：

#### 问题1：LED状态映射错误
```log
[00:01:19] [ERROR] [FSM] 更新LED状态失败: name 'STATE_BOOT' isn't defined
```

**根因分析**：
- `app/fsm/core.py` 中 `_update_led()` 函数使用了不存在的 `STATE_BOOT` 常量
- 当前简化后的FSM状态模型只定义了4个状态：`STATE_INIT`, `STATE_CONNECTING`, `STATE_RUNNING`, `STATE_ERROR`
- 但LED映射表仍然引用旧的 `STATE_BOOT` 常量

**影响范围**：
- 所有状态转换都会触发LED更新失败
- LED状态指示功能完全失效
- 错误日志频繁输出

#### 问题2：内存显示格式不够直观

**当前格式**：
```log
[00:01:19] [INFO ] [MAIN] 系统状态 - 状态:ERROR, 内存:110KB, 循环:1, WiFi:True, MQTT:False
```

**优化需求**：
- 显示内存占用百分比而非仅显示KB数值
- 提供更直观的内存使用情况判断

### 修复目标

#### 目标1：修复LED状态映射
- 从LED映射表中移除 `STATE_BOOT` 常量引用
- 确保所有状态都有正确的LED模式映射
- 验证LED状态指示功能正常工作

#### 目标2：优化内存显示格式
- 使用 `utils.helpers.check_memory()` 获取内存百分比
- 修改日志格式为：`内存:110KB(45%)`
- 提供更直观的内存使用状况

### 验收标准

1. **LED功能正常**：无"更新LED状态失败"错误
2. **编译通过**：`/build.py -c` 编译成功
3. **内存格式优化**：日志中显示内存占用百分比
4. **状态转换正常**：FSM状态转换无异常

### 风险与约束

**风险**：
- LED映射修改可能影响状态指示准确性
- 内存计算可能增加轻微性能开销

**约束**：
- 必须与现有FSM状态模型保持一致
- 不能引入新的依赖或重大架构变更
- 遵循最小改动原则

### 相关文件

**需要修改**：
- `app/fsm/core.py` - LED状态映射表
- `app/main.py` - 内存显示格式

**依赖文件**：
- `app/utils/helpers.py` - 内存百分比计算
- `app/hw/led.py` - LED控制接口

### 测试方案

1. **编译测试**：运行 `/build.py -c` 验证语法正确性
2. **功能测试**：观察运行日志确认错误消失
3. **回归测试**：验证状态转换和LED指示正常工作