# TODO清单 - IOT ESP32C3 后续优化

## 遗留问题

### 1. MQTT连接失败 🔴

**问题描述**：
```
[00:01:18] [ERROR] [MQTT] MQTT连接被拒绝: 服务器192.168.3.15:1883不可达或拒绝连接
```

**分析**：
- 非代码问题，属于网络配置或服务器问题
- 需要检查MQTT服务器状态和网络连通性
- 可能需要更新MQTT服务器地址或认证信息

**优先级**：中等
**负责模块**：网络配置

### 2. 系统运行验证 🟡

**问题描述**：
- 代码修复完成但未进行实际运行测试
- 需要验证LED状态指示是否正常工作
- 需要确认FSM状态转换是否按预期进行

**优先级**：高
**负责模块**：系统集成测试

## 待处理优化点

### 代码质量优化

#### 1. LED接口统一化 🟢

**目标**：统一LED控制接口，避免函数名混乱

**当前状态**：
- `play(pattern_id)` - 主要接口
- `set_led_mode(mode)` - 兼容性别名
- `init_led()` - 初始化接口

**建议**：
- 制定统一的LED接口规范
- 考虑使用类似 `led.set_pattern()`, `led.init()` 的命名约定
- 逐步迁移到统一接口

**优先级**：低
**预估工作量**：2-4小时

#### 2. FSM状态模型文档化 🟢

**目标**：完善状态机设计文档

**需要补充**：
- 状态转换图
- 各状态的职责和触发条件
- 异常处理和恢复策略
- 状态超时和重试机制

**优先级**：中等
**预估工作量**：4-6小时

#### 3. 单元测试覆盖 🟢

**目标**：为关键模块添加单元测试

**测试范围**：
- LED模块的各种模式切换
- FSM状态转换逻辑
- 网络连接和断开处理
- 错误恢复机制

**优先级**：中等
**预估工作量**：8-12小时

### 架构优化

#### 4. 接口抽象层引入 🔵

**目标**：减少模块间直接依赖

**当前问题**：
- FSM直接调用LED模块函数
- 主程序直接初始化各个模块
- 模块间耦合度较高

**建议方案**：
- 引入事件驱动架构
- 使用依赖注入模式
- 定义清晰的模块接口

**优先级**：低
**预估工作量**：16-24小时

#### 5. 配置管理优化 🔵

**目标**：改进配置文件管理和热更新

**当前限制**：
- 配置修改需要重启系统
- 缺少配置验证机制
- 敏感信息（如WiFi密码）明文存储

**建议改进**：
- 支持配置热重载
- 添加配置格式验证
- 实现敏感信息加密存储

**优先级**：低
**预估工作量**：12-16小时

### 性能优化

#### 6. 内存使用优化 🟡

**目标**：减少内存占用和碎片化

**当前状态**：
- 系统运行时内存约106KB
- 定期垃圾回收（30秒间隔）

**优化方向**：
- 分析内存使用热点
- 优化对象生命周期管理
- 考虑使用对象池模式

**优先级**：中等
**预估工作量**：6-8小时

#### 7. 网络重连策略优化 🟡

**目标**：改进网络断开后的重连机制

**当前问题**：
- 重连间隔固定
- 缺少退避策略
- 无最大重试次数限制

**建议改进**：
- 实现指数退避重连
- 添加最大重试次数
- 支持多网络配置轮询

**优先级**：中等
**预估工作量**：4-6小时

## 监控和维护

### 8. 日志系统增强 🟢

**目标**：改进日志记录和分析能力

**当前功能**：
- 基本的分级日志（INFO/WARN/ERROR）
- 模块标识支持

**建议增强**：
- 添加日志轮转机制
- 支持远程日志上传
- 实现关键指标监控
- 添加性能统计日志

**优先级**：中等
**预估工作量**：6-10小时

### 9. 健康检查机制 🟡

**目标**：完善系统健康监控

**当前功能**：
- 看门狗机制
- 基本的网络状态检查

**建议增强**：
- 添加更多健康检查指标
- 实现自动故障恢复
- 支持健康状态上报

**优先级**：中等
**预估工作量**：4-8小时

## 优先级说明

- 🔴 **紧急**：影响系统正常运行，需要立即处理
- 🟡 **高优先级**：重要功能，建议在下个版本中处理
- 🟢 **中优先级**：改进性功能，可以安排在后续版本
- 🔵 **低优先级**：长期优化目标，可以根据资源情况安排

## 下一步行动建议

1. **立即执行**：验证修复后的系统实际运行效果
2. **短期计划**：解决MQTT连接问题，完善FSM文档
3. **中期计划**：添加单元测试，优化网络重连策略
4. **长期规划**：架构重构，引入更好的设计模式

## 备注

- 所有优化都应该遵循最小改动原则
- 在进行大的架构调整前，确保有充分的测试覆盖
- 优先解决影响用户体验的问题
- 保持代码的可维护性和可读性