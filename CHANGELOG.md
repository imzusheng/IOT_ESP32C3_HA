# CHANGELOG

## [1.1.0] - 2025-08-04

### 🎉 重大优化 - 系统架构重构和功能精简

#### ✅ 已完成的主要修复：

##### 1. **看门狗管理优化**
- ✅ 集中看门狗初始化到主程序 (`main.py:82-84`)
- ✅ 统一在主循环中喂狗，确保系统稳定运行 (`main.py:148`)
- ✅ 修复WiFi连接失败时的看门狗处理
- ✅ 移除守护进程中的看门狗重复管理 (`sys_daemon.py:76,296,393,427`)
- ✅ 移除WiFi模块中的看门狗管理 (`net_wifi.py:85,127,190`)
- ✅ 移除NTP模块中的看门狗管理 (`net_wifi.py:85`)

##### 2. **蓝牙功能完全屏蔽**
- ✅ 删除 `BLE_ADV.md` 文档
- ✅ 删除 `src/ble_scanner.py` 文件
- ✅ 删除 `src/net_bt.py` 文件
- ✅ 删除 `src/config.py` 文件
- ✅ 清理配置文件中的蓝牙相关设置
- ✅ 屏蔽 `main.py` 中的蓝牙导入和功能 (`main.py:17`)
- ✅ 清理 `net_wifi.py` 中的蓝牙引用 (`net_wifi.py:127`)

##### 3. **配置管理系统统一**
- ✅ 删除旧的 `src/config.py` 文件
- ✅ 统一使用JSON配置文件 (`src/config.json`)
- ✅ 清理配置文件中的冗余蓝牙配置
- ✅ 优化配置加载和错误处理

##### 4. **内存管理优化**
- ✅ 实现智能垃圾回收策略
- ✅ 添加预防性内存管理
- ✅ 深度垃圾回收机制
- ✅ 分级内存使用阈值管理
- ✅ 优化内存监控和报告

##### 5. **代码清理和优化**
- ✅ 移除所有蓝牙相关导入
- ✅ 清理不必要的文件和代码
- ✅ 优化错误处理逻辑
- ✅ 改进代码注释和文档

### 📊 优化效果：

#### **内存使用优化**
- 删除了约50KB的蓝牙相关代码
- 移除了重复的配置管理系统
- 实现了更智能的垃圾回收策略
- 减少了系统资源占用

#### **系统稳定性提升**
- 统一了看门狗管理，避免冲突
- 修复了WiFi连接失败时的处理逻辑
- 改进了错误恢复机制
- 增强了内存管理

#### **代码简洁性**
- 移除了大量冗余代码
- 统一了配置管理方式
- 简化了系统架构
- 提高了可维护性

### 🎯 系统现在支持的特性：

1. **WiFi连接管理** - 多网络支持，自动重连
2. **MQTT通信** - 稳定的消息传输
3. **系统监控** - 温度、内存、LED状态
4. **错误处理** - 统一的错误管理和恢复
5. **看门狗保护** - 系统稳定性保障
6. **智能垃圾回收** - 内存使用优化

### 🔧 技术细节：

#### **看门狗管理**
- 集中在 `main.py` 中初始化和管理
- 超时时间配置：`config.json.daemon.wdt_timeout`
- 主循环中统一喂狗，避免多模块冲突

#### **配置系统**
- 统一使用 `src/config.json` 文件
- 支持分模块配置：`mqtt`, `wifi`, `daemon`, `system`, `device`
- 运行时配置验证和错误处理

#### **内存管理**
- 智能垃圾回收策略，根据内存使用动态调整
- 分级阈值管理：警告阈值、强制回收阈值
- 深度清理机制，防止内存泄漏

### 🚀 部署建议：

1. **测试验证** - 在实际设备上测试所有功能
2. **监控内存使用** - 观察优化效果
3. **日志记录** - 启用详细日志进行调试
4. **网络配置** - 确保WiFi和MQTT配置正确

### 📝 文件变更清单：

#### **删除的文件：**
- `BLE_ADV.md` - 蓝牙广告文档
- `src/ble_scanner.py` - 蓝牙扫描器模块
- `src/net_bt.py` - 蓝牙网络模块
- `src/config.py` - 旧的配置管理文件

#### **修改的文件：**
- `CLAUDE.md` - 更新项目文档
- `src/config.json` - 清理蓝牙配置
- `src/main.py` - 移除蓝牙功能，统一看门狗管理
- `src/net_wifi.py` - 清理蓝牙和看门狗引用
- `src/sys_daemon.py` - 移除看门狗管理

#### **保持不变的文件：**
- `src/boot.py` - 启动脚本
- `src/net_mqtt.py` - MQTT客户端
- `src/sys_error.py` - 错误处理
- `src/lib/umqtt/simple.py` - MQTT库

---

## [1.0.0] - 2025-07-XX

### 🎯 初始版本

#### **基础功能**
- ESP32C3 微控制器支持
- WiFi 连接管理
- MQTT 通信
- 系统监控（温度、内存、LED）
- 错误处理和恢复
- 看门狗保护
- 蓝牙扫描功能（已在1.1.0版本中移除）

#### **架构特性**
- 模块化设计
- 配置管理系统
- 内存优化
- 错误恢复机制
- 系统守护进程